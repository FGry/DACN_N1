<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh to√°n v√† ƒê·∫∑t h√†ng - BookStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS gi·ªØ nguy√™n nh∆∞ ban ƒë·∫ßu */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: white !important;
        }

        .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            color: white !important;
            transform: translateY(-2px);
        }

        .btn-auth {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            margin: 0 5px;
            transition: all 0.3s ease;
        }

        .btn-auth:hover {
            background: white;
            color: #667eea;
        }

        .cart-icon {
            position: relative;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-container {
            margin-top: 80px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 30px;
        }

        .checkout-header {
            color: #667eea;
            font-weight: 600;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .form-section {
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        /* Cart Item Styles */
        .cart-item {
            border-bottom: 1px solid #e9ecef;
            padding: 15px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.95rem;
        }

        .cart-item-image {
            width: 60px; /* Nh·ªè h∆°n ƒë·ªÉ ph√π h·ª£p v·ªõi c·ªôt t·ªïng quan */
            height: 60px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid #eee;
            margin-right: 15px;
        }

        .product-info-col {
            display: flex;
            align-items: center;
            width: 60%;
        }
        .price-col {
            width: 15%;
            text-align: right;
            font-weight: 600;
        }
        .quantity-col {
            width: 10%;
            text-align: center;
        }
        .total-col {
            width: 15%;
            text-align: right;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        /* Summary Styles */
        .cart-summary {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            position: sticky;
            top: 100px;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-checkout {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-checkout:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }

        .payment-option input[type="radio"] {
            margin-right: 10px;
        }

        .payment-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .payment-box:hover {
            border-color: #667eea;
        }
        .payment-box.active {
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.5);
            background: #f0f4ff;
        }

        .footer {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px 0 20px 0;
            margin-top: 60px;
        }

        .empty-cart {
            text-align: center;
            color: #6c757d;
            padding: 60px 0;
        }

        .quantity-btn {
            border: 1px solid #ced4da;
            background: white;
            width: 32px;
            height: 32px;
            border-radius: 5px;
            transition: background 0.2s;
        }

        .quantity-btn:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="http://localhost:8080/"><i class="fas fa-book-open"></i> BookStore</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="http://localhost:8080/">Trang ch·ªß</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/products}">S·∫£n ph·∫©m</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/about}">Gi·ªõi thi·ªáu</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/contact}">Li√™n h·ªá</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{user/voucher}">Voucher</a>
                </li>
            </ul>

            <div class="d-flex align-items-center" id="authButtons">

                <div id="loggedOutButtons" th:if="${!isLoggedIn}">
                    <a th:href="@{/login}" href="login.html" class="btn btn-auth btn-sm">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                    </a>
                    <a th:href="@{/register}" href="register.html" class="btn btn-auth btn-sm">
                        <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω
                    </a>
                </div>

                <div id="loggedInButtons" th:if="${isLoggedIn}">
                    <div class="dropdown">
                        <button class="btn btn-auth btn-sm dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle"></i>
                            <span id="userNameDisplay" th:text="${currentUser.username}">T√†i kho·∫£n</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                            <li><a class="dropdown-item" th:href="@{/user/profile}">
                                <i class="fas fa-info-circle"></i> Th√¥ng tin c√° nh√¢n
                            </a></li>

                            <li><a class="dropdown-item" th:href="@{/user/profile#address-settings}">
                                <i class="fas fa-map-marked-alt"></i> C·∫≠p nh·∫≠t ƒê·ªãa ch·ªâ
                            </a></li>

                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" th:href="@{/logout}">
                                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                            </a></li>
                        </ul>
                    </div>
                </div>

                <div class="cart-icon ms-3" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#cartModal">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-badge" id="cartCount">0</span>
                </div>
            </div>
        </div>
    </div>
</nav>

<div class="container cart-container">
    <h2 class="mb-5 checkout-header"><i class="fas fa-shipping-fast"></i> ƒê·∫∑t h√†ng v√† Thanh to√°n</h2>

    <div id="checkoutForm" class="row" >
        <div class="col-lg-7">
            <div class="form-section">
                <h4 class="mb-4 text-secondary"><i class="fas fa-map-marker-alt"></i> Th√¥ng tin nh·∫≠n h√†ng</h4>

                <div class="mb-3 d-flex align-items-center">
                    <div class="flex-grow-1 me-3">
                        <label for="deliveryAddress" class="form-label fw-bold">Ch·ªçn ƒê·ªãa ch·ªâ nh·∫≠n h√†ng</label>
                        <select id="deliveryAddress" class="form-select" onchange="updateDeliveryInfo(this.value)">
                            <option value="" disabled selected>-- Ch·ªçn ƒë·ªãa ch·ªâ ho·∫∑c nh·∫≠p m·ªõi --</option>
                        </select>
                    </div>
                    <div>
                        <label class="form-label fw-bold opacity-0">Action</label>
                        <a href="/user/profile#address-settings" class="btn btn-sm btn-outline-secondary d-block">
                            <i class="fas fa-plus"></i> Th√™m/S·ª≠a
                        </a>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="orderNotes" class="form-label fw-bold">
                        Ghi ch√∫ ƒë∆°n h√†ng (T√πy ch·ªçn)
                    </label>
                    <textarea id="orderNotes" class="form-control" rows="2" placeholder="V√≠ d·ª•: Giao h√†ng v√†o bu·ªïi chi·ªÅu, kh√¥ng g·ªçi ƒëi·ªán tr∆∞·ªõc..."></textarea>
                </div>
            </div>

            <div class="form-section">
                <h4 class="mb-4 text-secondary"><i class="fas fa-wallet"></i> Ph∆∞∆°ng th·ª©c thanh to√°n</h4>

                <div id="paymentCodBox" class="payment-box active" onclick="selectPayment('cod')">
                    <label class="form-check-label d-flex align-items-center fw-bold">
                        <input class="form-check-input" type="radio" name="paymentMethod" value="cod" checked>
                        <i class="fas fa-money-bill-wave me-2"></i> Thanh to√°n khi nh·∫≠n h√†ng (COD)
                    </label>
                </div>

                <div id="paymentBankBox" class="payment-box" onclick="selectPayment('bank')">
                    <label class="form-check-label d-flex align-items-center fw-bold">
                        <input class="form-check-input" type="radio" name="paymentMethod" value="bank">
                        <i class="fas fa-university me-2"></i> Chuy·ªÉn kho·∫£n Ng√¢n h√†ng
                    </label>
                </div>

                <div id="paymentMomoBox" class="payment-box" onclick="selectPayment('momo')">
                    <label class="form-check-label d-flex align-items-center fw-bold">
                        <input class="form-check-input" type="radio" name="paymentMethod" value="momo">
                        <i class="fas fa-qrcode me-2"></i> V√≠ ƒëi·ªán t·ª≠ MoMo
                    </label>
                </div>
            </div>

            <div class="form-section">
                <h4 class="mb-4 text-secondary"><i class="fas fa-box"></i> Chi ti·∫øt ƒë∆°n h√†ng</h4>

                <div class="d-flex fw-bold text-muted border-bottom pb-2 mb-3">
                    <div class="product-info-col">S·∫£n ph·∫©m</div>
                    <div class="price-col">Gi√°</div>
                    <div class="quantity-col">SL</div>
                    <div class="total-col">T·ªïng</div>
                </div>

                <div id="cartItems">
                </div>

                <div id="emptyCart" class="empty-cart d-none">
                    <i class="fas fa-box-open fa-4x mb-3"></i>
                    <h5>Gi·ªè h√†ng tr·ªëng</h5>
                    <p>Vui l√≤ng th√™m s·∫£n ph·∫©m ƒë·ªÉ ti·∫øp t·ª•c.</p>
                </div>

                <button class="btn btn-sm btn-outline-secondary mb-3 mt-3" onclick="clearCart()">
                    <i class="fas fa-trash-alt"></i> X√≥a to√†n b·ªô gi·ªè h√†ng
                </button>
            </div>

        </div>

        <div class="col-lg-5">
            <div id="cartSummary" class="cart-summary">
                <h4 class="mb-4 text-secondary"><i class="fas fa-file-invoice-dollar"></i> T√≥m t·∫Øt Thanh to√°n</h4>

                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Nh·∫≠p m√£ voucher" id="voucherCode">
                    <button class="btn btn-primary-custom" onclick="applyVoucher()">√Åp d·ª•ng</button>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-normal">T·ªïng ti·ªÅn h√†ng:</h5>
                    <h5 id="subTotalPrice" class="fw-normal">0ƒë</h5>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-normal text-success">Gi·∫£m gi√° Voucher:</h5>
                    <h5 id="voucherDiscount" class="fw-normal text-success">- 0ƒë</h5>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-normal">Ph√≠ v·∫≠n chuy·ªÉn:</h5>
                    <h5 id="shippingFee" class="fw-normal">Mi·ªÖn ph√≠</h5>
                </div>

                <hr>

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>T·ªïng thanh to√°n:</h3>
                    <h3 id="totalPrice" class="text-danger">0ƒë</h3>
                </div>

                <button class="btn btn-checkout w-100" id="placeOrderButton" onclick="placeOrder()">
                    <i class="fas fa-check-circle"></i> ƒê·∫∑t h√†ng
                </button>
            </div>
        </div>
    </div>

</div>

<footer class="footer mt-5">
    <div class="container text-center">
        <p>&copy; 2024 BookStore. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
    </div>
</footer>

<script>

    let cart = JSON.parse(localStorage.getItem('bookstoreCart')) || [];
    let currentVoucherDiscount = 0;
    let currentVoucherId = null;
    let currentSubTotal = 0;

    // üí° TH√äM: ƒê·ªãnh nghƒ©a mockProducts ƒë·ªÉ tr√°nh l·ªói khi gi·ªè h√†ng tr·ªëng ban ƒë·∫ßu
    const mockProducts = [
        { idProducts: 101, title: 'S√°ch L·∫≠p Tr√¨nh Java', price: 120000, imageLink: 'https://via.placeholder.com/60x60/88AAFF?text=Java' },
        { idProducts: 102, title: 'S√°ch Thu·∫≠t To√°n CƒÉn B·∫£n', price: 80000, imageLink: 'https://via.placeholder.com/60x60/FF88AA?text=Algo' }
    ];

    function formatPrice(price) {
        if (typeof price !== 'number' || price < 0) price = 0;
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
    }

    function saveCart() {
        localStorage.setItem('bookstoreCart', JSON.stringify(cart));
        renderCart();
    }


    // üí° L∆ØU √ù: H√†m n√†y ch·ªâ tr·∫£ v·ªÅ gi√° tr·ªã gi·∫£ l·∫≠p. C·∫ßn thay b·∫±ng gi√° tr·ªã User ID th·∫≠t.
    function getUserId() {
        return 1;
    }


    function calculateSubTotal() {
        return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    }

    function renderCart() {
        const cartItemsDiv = document.getElementById('cartItems');
        const emptyCart = document.getElementById('emptyCart');

        currentSubTotal = calculateSubTotal();
        let totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

        const cartBadge = document.getElementById('cartCount');
        if (cartBadge) cartBadge.textContent = totalItems;

        if (cart.length === 0) {
            cartItemsDiv.innerHTML = '';
            document.getElementById('checkoutForm').classList.add('d-none');
            emptyCart.classList.remove('d-none');
            updateSummary(0);
            return;
        }

        document.getElementById('checkoutForm').classList.remove('d-none');
        emptyCart.classList.add('d-none');

        let html = '';

        cart.forEach(item => {
            const id = item.idProducts || item.id;
            const itemName = item.title || item.name || 'S·∫£n ph·∫©m kh√¥ng r√µ t√™n';
            const itemPrice = item.price || 0;
            const itemQuantity = item.quantity;
            const itemTotal = itemPrice * itemQuantity;

            let imageLink = item.imageLink || 'https://via.placeholder.com/60x60/EEEEEE?text=Book';

            html += `
                <div class="cart-item">
                    <div class="product-info-col">
                        <img src="${imageLink}" alt="${itemName}" class="cart-item-image">
                        <span class="mb-0">${itemName}</span>
                    </div>
                    <div class="price-col">
                        ${formatPrice(itemPrice)}
                    </div>
                    <div class="quantity-col d-flex align-items-center justify-content-center">
                        <button class="quantity-btn me-1" onclick="updateQuantity(${id}, -1)">-</button>
                        <span class="mx-1">${itemQuantity}</span>
                        <button class="quantity-btn ms-1" onclick="updateQuantity(${id}, 1)">+</button>
                    </div>
                    <div class="total-col d-flex align-items-center justify-content-end">
                        <strong class="text-danger">${formatPrice(itemTotal)}</strong>
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeItem(${id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        cartItemsDiv.innerHTML = html;
        updateSummary(currentSubTotal);
    }

    function renderAddressOptions() {
        const select = document.getElementById('deliveryAddress');
        select.innerHTML = '<option value="" disabled selected>-- ƒêang t·∫£i ƒë·ªãa ch·ªâ... --</option>';

        // üí° S·ª¨A ƒê∆Ø·ªúNG D·∫™N API: Ph·∫£i kh·ªõp v·ªõi AddressController: /user/address/addresses
        fetch('/user/address/addresses')
            .then(response => {
                // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p, backend c√≥ th·ªÉ tr·∫£ v·ªÅ 401 ho·∫∑c 403
                if (!response.ok) {
                    console.error('Kh√¥ng th·ªÉ t·∫£i ƒë·ªãa ch·ªâ. L·ªói HTTP:', response.status);
                    if (response.status === 401 || response.status === 403) {
                        select.innerHTML = '<option value="" disabled selected>-- Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem ƒë·ªãa ch·ªâ --</option>';
                    } else {
                        select.innerHTML = '<option value="" disabled selected>-- L·ªói t·∫£i ƒë·ªãa ch·ªâ --</option>';
                    }
                    return null; // Tr·∫£ v·ªÅ null ƒë·ªÉ tho√°t kh·ªèi chu·ªói .then ti·∫øp theo
                }
                return response.json();
            })
            .then(userAddresses => {
                if (userAddresses === null) return; // Tho√°t n·∫øu c√≥ l·ªói HTTP

                let optionsHtml = '<option value="" disabled selected>-- Ch·ªçn ƒë·ªãa ch·ªâ ho·∫∑c nh·∫≠p m·ªõi --</option>';

                if (userAddresses && userAddresses.length > 0) {
                    userAddresses.forEach(addr => {
                        // Backend tr·∫£ v·ªÅ AddressDTO: idAddress, fullAddressDetail, phone
                        optionsHtml += `<option value="${addr.idAddress}" data-phone="${addr.phone}">${addr.fullAddressDetail}</option>`;
                    });
                }
                select.innerHTML = optionsHtml;

                // T·ª± ƒë·ªông ch·ªçn ƒë·ªãa ch·ªâ ƒë·∫ßu ti√™n ho·∫∑c chuy·ªÉn sang nh·∫≠p m·ªõi
                if (userAddresses && userAddresses.length > 0) {
                    select.value = userAddresses[0].idAddress;
                    updateDeliveryInfo(userAddresses[0].idAddress);
                } else {
                    select.innerHTML = '<option value="" disabled selected>-- Vui l√≤ng th√™m ƒë·ªãa ch·ªâ nh·∫≠n h√†ng --</option>';
                }
            })
            .catch(error => {
                console.error('L·ªói k·∫øt n·ªëi khi t·∫£i ƒë·ªãa ch·ªâ:', error);
                select.innerHTML = '<option value="" disabled selected>-- L·ªói t·∫£i ƒë·ªãa ch·ªâ (Ki·ªÉm tra Server) --</option>';
            });
    }

    function updateSummary(subTotal) {
        const shippingFee = 0;

        let finalTotal = subTotal - currentVoucherDiscount + shippingFee;
        if (finalTotal < 0) finalTotal = 0;

        document.getElementById('subTotalPrice').textContent = formatPrice(subTotal);
        document.getElementById('voucherDiscount').textContent = formatPrice(currentVoucherDiscount);
        document.getElementById('shippingFee').textContent = shippingFee === 0 ? 'Mi·ªÖn ph√≠' : formatPrice(shippingFee);
        document.getElementById('totalPrice').textContent = formatPrice(finalTotal);

        document.getElementById('totalPrice').dataset.longValue = finalTotal;
    }


    function updateDeliveryInfo(selectedId) {
        console.log(`ƒê·ªãa ch·ªâ ƒë√£ ch·ªçn (ID): ${selectedId}`);
    }

    function selectPayment(method) {
        document.querySelectorAll('.payment-box').forEach(box => {
            box.classList.remove('active');
        });
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.checked = false;
        });

        const selectedRadio = document.querySelector(`.payment-box input[value="${method}"]`);
        if (selectedRadio) {
            selectedRadio.checked = true;
            selectedRadio.closest('.payment-box').classList.add('active');
        }
    }

    function updateQuantity(id, change) {
        const item = cart.find(p => (p.idProducts === id) || (p.id === id));
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                cart = cart.filter(p => (p.idProducts !== id) && (p.id !== id));
                currentVoucherDiscount = 0; // Reset voucher khi gi·ªè h√†ng thay ƒë·ªïi
                currentVoucherId = null;
            }
        }
        saveCart();
    }

    function removeItem(id) {
        cart = cart.filter(p => (p.idProducts !== id) && (p.id !== id));
        currentVoucherDiscount = 0; // Reset voucher
        currentVoucherId = null;
        saveCart();
    }

    function clearCart() {
        if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng?")) {
            cart = [];
            currentVoucherDiscount = 0;
            currentVoucherId = null;
            saveCart();
        }
    }

    function applyVoucher() {
        const code = document.getElementById('voucherCode').value.trim();
        const subTotal = calculateSubTotal();

        if (subTotal === 0) {
            alert('Gi·ªè h√†ng tr·ªëng!');
            return;
        }

        // MOCK LOGIC VOUCHER
        if (code === 'HOCSINH20') {
            currentVoucherDiscount = Math.min(subTotal * 0.2, 50000); // T·ªëi ƒëa 50k
            currentVoucherId = 1; // Gi·∫£ s·ª≠ ID c·ªßa voucher HOCSINH20 l√† 1
            alert(`√Åp d·ª•ng m√£ gi·∫£m gi√° th√†nh c√¥ng! Gi·∫£m ${formatPrice(currentVoucherDiscount)}.`);
        } else {
            currentVoucherDiscount = 0;
            currentVoucherId = null;
            alert('M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá (D√πng m√£: HOCSINH20, gi·∫£m t·ªëi ƒëa 50k).');
        }
        updateSummary(subTotal);
    }

    async function placeOrder() {
        if (cart.length === 0) {
            alert('Gi·ªè h√†ng tr·ªëng! Vui l√≤ng th√™m s·∫£n ph·∫©m ƒë·ªÉ ƒë·∫∑t h√†ng.');
            return;
        }

        // V√¥ hi·ªáu h√≥a n√∫t ƒë·ªÉ tr√°nh g·ª≠i nhi·ªÅu l·∫ßn
        const orderButton = document.getElementById('placeOrderButton');
        orderButton.disabled = true;
        orderButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ƒêang ƒë·∫∑t h√†ng...';

        const addressSelect = document.getElementById('deliveryAddress');
        const selectedAddressValue = addressSelect.value;
        const orderNotes = document.getElementById('orderNotes').value.trim();
        const paymentMethodElement = document.querySelector('input[name="paymentMethod"]:checked');

        // 1. Ki·ªÉm tra c∆° b·∫£n
        if (!selectedAddressValue || selectedAddressValue === 'new' && (!document.getElementById('newAddressDetail').value.trim() || !document.getElementById('newAddressPhone').value.trim())) {
            alert('Vui l√≤ng ch·ªçn ho·∫∑c nh·∫≠p ƒë·∫ßy ƒë·ªß ƒë·ªãa ch·ªâ nh·∫≠n h√†ng.');
            orderButton.disabled = false;
            orderButton.innerHTML = '<i class="fas fa-check-circle"></i> ƒê·∫∑t h√†ng';
            return;
        }

        if (!paymentMethodElement) {
            alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n.');
            orderButton.disabled = false;
            orderButton.innerHTML = '<i class="fas fa-check-circle"></i> ƒê·∫∑t h√†ng';
            return;
        }

        // 2. L·∫•y th√¥ng tin ƒë·ªãa ch·ªâ cu·ªëi c√πng
        let finalAddressDetail = '';
        let finalPhoneNumber = '';

        if (selectedAddressValue === 'new') {
            finalAddressDetail = document.getElementById('newAddressDetail').value.trim();
            finalPhoneNumber = document.getElementById('newAddressPhone').value.trim();
        } else {
            const selectedOption = addressSelect.querySelector(`option[value="${selectedAddressValue}"]`);
            finalAddressDetail = selectedOption ? selectedOption.textContent.trim() : 'ƒê·ªãa ch·ªâ ƒë√£ l∆∞u';
            finalPhoneNumber = selectedOption ? selectedOption.getAttribute('data-phone') : null;
        }

        if (!finalPhoneNumber) {
            alert('Kh√¥ng t√¨m th·∫•y s·ªë ƒëi·ªán tho·∫°i. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãa ch·ªâ.');
            orderButton.disabled = false;
            orderButton.innerHTML = '<i class="fas fa-check-circle"></i> ƒê·∫∑t h√†ng';
            return;
        }

        // 3. Chu·∫©n b·ªã d·ªØ li·ªáu cho API
        const totalAmount = parseInt(document.getElementById('totalPrice').dataset.longValue) || 0;

        const orderItemRequests = cart.map(item => ({
            productId: item.idProducts || item.id,
            quantity: item.quantity,
            priceAtDate: item.price
        }));

        const orderCreationRequest = {
            userId: getUserId(),
            address: finalAddressDetail,
            phone: finalPhoneNumber,
            paymentMethod: paymentMethodElement.value.toUpperCase(),
            note: orderNotes,
            voucherId: currentVoucherId,
            totalAmount: totalAmount,
            items: orderItemRequests
        };

        console.log("D·ªØ li·ªáu g·ª≠i l√™n API:", orderCreationRequest);

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderCreationRequest)
            });

            if (response.ok) {
                const result = await response.json();
                alert(`üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n h√†ng: ${result.orderCode || result.idOrder}. T·ªïng ti·ªÅn: ${formatPrice(result.totalAmount)}`);

                cart = [];
                currentVoucherDiscount = 0;
                currentVoucherId = null;
                saveCart();
                window.location.href = '/user/profile#orders-settings';

            } else {
                // Th·ª≠ ƒë·ªçc chi ti·∫øt l·ªói n·∫øu c√≥
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.message || `L·ªói kh√¥ng x√°c ƒë·ªãnh (${response.status} ${response.statusText})`;
                alert(`üî¥ L·ªói ƒë·∫∑t h√†ng: ${errorMessage}`);
            }

        } catch (error) {
            console.error('L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω:', error);
            alert('L·ªói k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.');
        } finally {
            orderButton.disabled = false;
            orderButton.innerHTML = '<i class="fas fa-check-circle"></i> ƒê·∫∑t h√†ng';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (cart.length === 0) {
            cart.push({ ...mockProducts[0], quantity: 2 });
            cart.push({ ...mockProducts[1], quantity: 1 });
            localStorage.setItem('bookstoreCart', JSON.stringify(cart));
        }

        renderAddressOptions();
        renderCart();
        selectPayment('cod');
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>