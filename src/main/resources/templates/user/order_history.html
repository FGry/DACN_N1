<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch sử Đơn hàng - BookStore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f5f7fa; }
        .order-card {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .PENDING { background-color: #ffc107; color: #343a40; }
        .CONFIRMED { background-color: #17a2b8; color: white; }
        .SHIPPING { background-color: #007bff; color: white; }
        .DELIVERED { background-color: #28a745; color: white; }
        .CANCELLED { background-color: #dc3545; color: white; }
        .order-header {
            border-bottom: 1px solid #e0e0e0;
        }
        .modal-product-table th, .modal-product-table td {
            vertical-align: middle;
        }
    </style>
</head>
<body>

<div class="container mt-5">
    <h2 class="mb-4 text-primary"><i class="fas fa-history"></i> Lịch sử Đơn hàng của bạn</h2>

    <div th:if="${error}" class="alert alert-danger" role="alert">
        <span th:text="${error}"></span>
    </div>

    <div id="loading" class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Đang tải đơn hàng...</p>
    </div>

    <div id="ordersList" class="row">
    </div>

    <div id="noOrders" class="alert alert-info text-center d-none p-5">
        <i class="fas fa-box-open fa-3x mb-3"></i>
        <h4>Bạn chưa có đơn hàng nào.</h4>
        <p>Hãy bắt đầu mua sắm ngay!</p>
    </div>
</div>

<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="orderDetailModalLabel">
                    Chi tiết Đơn hàng: <span id="modalOrderCode">#DH000</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-lg-5">
                        <h6 class="text-secondary"><i class="fas fa-info-circle me-1"></i> Thông tin chung</h6>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item"><strong>Trạng thái:</strong> <span id="modalStatus" class="status-badge"></span></li>
                            <li class="list-group-item"><strong>Ngày đặt:</strong> <span id="modalDate"></span></li>
                            <li class="list-group-item"><strong>Khách hàng:</strong> <span id="modalCustomer"></span></li>
                            <li class="list-group-item"><strong>Điện thoại:</strong> <span id="modalPhone"></span></li>
                            <li class="list-group-item"><strong>Thanh toán:</strong> <span id="modalPayment"></span></li>
                            <li class="list-group-item"><strong>Địa chỉ:</strong> <span id="modalAddress"></span></li>
                            <li class="list-group-item"><strong>Ghi chú:</strong> <span id="modalNote" class="fst-italic text-muted"></span></li>
                        </ul>
                    </div>

                    <div class="col-lg-7">
                        <h6 class="text-secondary"><i class="fas fa-file-invoice-dollar me-1"></i> Tổng kết</h6>
                        <ul class="list-group list-group-flush mb-3">
                            <li class="list-group-item d-flex justify-content-between">
                                <strong>Tổng tiền hàng:</strong>
                                <span id="modalSubTotal"></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between text-success">
                                <strong>Giảm giá Voucher:</strong>
                                <span>- <span id="modalVoucherDiscount">0đ</span></span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <strong>Phí vận chuyển:</strong>
                                <span>Miễn phí</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between bg-light fw-bold">
                                <h4>Tổng thanh toán:</h4>
                                <h4 class="text-danger" id="modalTotalAmount"></h4>
                            </li>
                        </ul>
                    </div>
                </div>

                <hr>

                <h6 class="text-secondary mb-3"><i class="fas fa-boxes me-1"></i> Sản phẩm trong đơn hàng (<span id="modalTotalProducts"></span>)</h6>
                <div class="table-responsive">
                    <table class="table table-bordered modal-product-table">
                        <thead>
                        <tr class="table-primary">
                            <th>#</th>
                            <th>Tên sản phẩm</th>
                            <th>Tác giả</th>
                            <th>Giá bán</th>
                            <th>SL</th>
                            <th>Thành tiền</th>
                        </tr>
                        </thead>
                        <tbody id="modalProductDetailsBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript"> // ⬅️ QUAN TRỌNG: Kích hoạt chế độ inline Javascript

const USER_ID = /*[[${currentUserId}]]*/ null;

if (USER_ID === null || USER_ID === 0) {
    console.error("Lỗi: Không thể lấy ID người dùng hiện tại từ Server.");
    document.getElementById('loading').classList.add('d-none');
    document.getElementById('noOrders').innerHTML = '<h4 class="text-danger">Lỗi bảo mật: Không thể xác định tài khoản. Vui lòng đăng nhập lại.</h4>';
    document.getElementById('noOrders').classList.remove('d-none');
    window.fetchOrders = () => {};
}

const API_URL = `/api/users/${USER_ID}/orders`;
const DETAIL_API_URL = '/api/orders/detail/';

function formatPrice(price) {
    if (typeof price !== 'number' || price < 0) price = 0;
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
}

function getStatusLabel(status) {
    switch (status) {
        case 'PENDING': return 'Chờ xác nhận';
        case 'CONFIRMED': return 'Đã xác nhận';
        case 'SHIPPING': return 'Đang vận chuyển';
        case 'DELIVERED': return 'Đã giao hàng';
        case 'CANCELLED': return 'Đã hủy';
        default: return status;
    }
}

function redirectToReview(orderId, productDetails) {
    if (productDetails && productDetails.length > 0) {
        alert(`Chuyển hướng đến trang đánh giá cho Đơn hàng #${orderId}.`);
    } else {
        alert(`Đơn hàng #${orderId} không có chi tiết sản phẩm để đánh giá.`);
    }
}

function renderOrders(orders) {
    const ordersListDiv = document.getElementById('ordersList');
    const noOrdersDiv = document.getElementById('noOrders');
    ordersListDiv.innerHTML = '';

    if (!orders || orders.length === 0) {
        noOrdersDiv.classList.remove('d-none');
        return;
    }

    noOrdersDiv.classList.add('d-none');

    orders.forEach(order => {
        const statusLabel = getStatusLabel(order.status);
        const details = order.productDetails || [];

        const visibleItems = details.slice(0, 2);
        const remainingItemsCount = details.length - visibleItems.length;

        let itemsHtml = visibleItems.map(item => `
                <div class="d-flex justify-content-between text-muted ms-3">
                    <span class="text-truncate" style="max-width: 80%;">${item.productName} (x${item.quantity})</span>
                    <span class="fw-bold">${item.priceAtDateFormatted}</span>
                </div>
            `).join('');

        if (remainingItemsCount > 0) {
            itemsHtml += `<p class="text-muted fst-italic ms-3 mt-1 mb-0">+ ${remainingItemsCount} sản phẩm khác</p>`;
        } else if (details.length === 0) {
            itemsHtml = `<p class="text-muted fst-italic ms-3 mt-1 mb-0">Không có chi tiết sản phẩm.</p>`;
        }

        let actionButtons = `
                <button class="btn btn-sm btn-outline-primary" onclick="showOrderDetails(${order.idOrder})">
                    <i class="fas fa-eye"></i> Xem chi tiết
                </button>
            `;

        if (order.status === 'DELIVERED') {
            actionButtons += `
                    <button class="btn btn-sm btn-success ms-2" onclick='redirectToReview(${order.idOrder}, ${JSON.stringify(details)})'>
                        <i class="fas fa-star"></i> Đánh giá
                    </button>
                `;
        } else if (order.status === 'PENDING' || order.status === 'CONFIRMED') {
            // Giả định bạn có một API để hủy đơn hàng
            actionButtons += `
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="cancelOrder(${order.idOrder})">
                        <i class="fas fa-times-circle"></i> Hủy đơn
                    </button>
                `;
        }

        const orderCard = `
                <div class="col-lg-6 col-md-12">
                    <div class="card order-card">
                        <div class="card-header order-header d-flex justify-content-between align-items-center bg-white p-3">
                            <h5 class="mb-0 text-primary fw-bold">${order.orderCode}</h5>
                            <span class="status-badge ${order.status}">${statusLabel}</span>
                        </div>
                        <div class="card-body p-3">
                            <p class="mb-1"><strong>Ngày đặt:</strong> ${order.dateFormatted}</p>
                            <p class="mb-1"><strong>Tổng tiền:</strong> <span class="text-danger fw-bold">${order.totalAmountFormatted}</span></p>
                            <p class="mb-2"><strong>Địa chỉ:</strong> ${order.address || 'N/A'}</p>

                            <hr class="my-2">
                            <h6>Chi tiết sản phẩm (${order.totalProducts} cuốn):</h6>
                            ${itemsHtml}
                        </div>
                        <div class="card-footer bg-white p-3 text-end">
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            `;
        ordersListDiv.insertAdjacentHTML('beforeend', orderCard);
    });
}

async function fetchOrders() {
    document.getElementById('loading').classList.remove('d-none');
    document.getElementById('noOrders').classList.add('d-none');
    document.getElementById('ordersList').innerHTML = '';

    // Ngăn chặn chạy nếu USER_ID không hợp lệ (đã được xử lý ở trên)
    if (USER_ID === null || USER_ID === 0) {
        document.getElementById('loading').classList.add('d-none');
        return;
    }

    try {
        const response = await fetch(API_URL);
        if (!response.ok) {
            throw new Error(`Lỗi HTTP: ${response.status} khi tải lịch sử đơn hàng.`);
        }
        const orders = await response.json();
        renderOrders(orders);
    } catch (error) {
        console.error(error);
        alert('Không thể tải lịch sử đơn hàng. Vui lòng thử lại.');
        document.getElementById('noOrders').classList.remove('d-none');
    } finally {
        document.getElementById('loading').classList.add('d-none');
    }
}

async function showOrderDetails(orderId) {
    const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
    const modalTitle = document.getElementById('modalOrderCode');
    const modalBody = document.getElementById('modalProductDetailsBody');

    modalTitle.textContent = `#DH${orderId}`;
    modalBody.innerHTML = '<tr><td colspan="6" class="text-center">Đang tải chi tiết...</td></tr>';

    modal.show();

    try {
        const response = await fetch(DETAIL_API_URL + orderId);
        if (!response.ok) {
            throw new Error(`Lỗi HTTP: ${response.status}`);
        }
        const detailData = await response.json();

        fillModalContent(detailData);

    } catch (error) {
        console.error("Lỗi tải chi tiết đơn hàng:", error);
        modalBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Lỗi: Không thể tải chi tiết đơn hàng này.</td></tr>';
    }
}

function fillModalContent(data) {
    // --- Thông tin chung ---
    document.getElementById('modalOrderCode').textContent = data.orderCode;
    document.getElementById('modalStatus').textContent = getStatusLabel(data.status);
    document.getElementById('modalStatus').className = `status-badge ${data.status}`;
    document.getElementById('modalDate').textContent = data.dateFormatted;
    document.getElementById('modalCustomer').textContent = data.customerUsername;
    document.getElementById('modalPhone').textContent = data.customerPhone;
    document.getElementById('modalPayment').textContent = data.paymentMethod;
    document.getElementById('modalAddress').textContent = data.address || 'Không có';
    document.getElementById('modalNote').textContent = data.note || 'Không có ghi chú';

    // --- Tổng kết ---
    document.getElementById('modalTotalAmount').textContent = data.totalAmountFormatted;
    document.getElementById('modalSubTotal').textContent = data.totalAmountFormatted;
    document.getElementById('modalVoucherDiscount').textContent = '0đ';
    document.getElementById('modalTotalProducts').textContent = data.totalProducts;

    // --- Chi tiết sản phẩm ---
    const detailsBody = document.getElementById('modalProductDetailsBody');
    detailsBody.innerHTML = '';

    if (data.productDetails && data.productDetails.length > 0) {
        data.productDetails.forEach((item, index) => {
            const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.productName}</td>
                        <td>${item.productAuthor || 'N/A'}</td>
                        <td>${item.priceAtDateFormatted}</td>
                        <td>${item.quantity}</td>
                        <td><strong class="text-danger">${formatPrice(item.priceAtDate * item.quantity)}</strong></td>
                    </tr>
                `;
            detailsBody.insertAdjacentHTML('beforeend', row);
        });
    } else {
        detailsBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Không có chi tiết sản phẩm.</td></tr>';
    }
}


function cancelOrder(orderId) {
    if(confirm(`Bạn có chắc chắn muốn hủy đơn hàng #${orderId} không? Việc này không thể hoàn tác.`)) {
        alert(`Yêu cầu hủy đơn hàng #${orderId} đã được gửi.`);
        fetchOrders();
    }
}

document.addEventListener('DOMContentLoaded', fetchOrders);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>