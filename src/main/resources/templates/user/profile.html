<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cài đặt Tài khoản - BookHub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS ĐỒNG BỘ */
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .settings-container {
            max-width: 900px;
            margin: auto;
            padding: 40px 15px;
        }

        .settings-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        .nav-pills .nav-link {
            color: #495057;
            background: #e9ecef;
            margin-right: 10px;
            border-radius: 10px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .nav-pills .nav-link.active {
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-custom-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .btn-custom-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            padding-top: 25px;
        }

        .password-container {
            position: relative;
        }

        /* Căn giữa icon trong input group */
        .password-container .toggle-password {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-50%);
            cursor: pointer;
            color: #6c757d;
            z-index: 10;
        }

        .form-control[readonly], .form-select[disabled] {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        /* Cần thiết lập lại khoảng cách cho container password nếu dùng g-3 */
        .password-container input {
            padding-right: 35px; /* Để chừa chỗ cho icon */
        }

        /* START Order History CSS */
        .order-card {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }
        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }
        .status-badge {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .PENDING { background-color: #ffc107; color: #343a39; }
        .CONFIRMED { background-color: #17a2b8; color: white; }
        .SHIPPING { background-color: #007bff; color: white; }
        .DELIVERED { background-color: #28a745; color: white; }
        .CANCELLED { background-color: #dc3545; color: white; }
        .order-header {
            border-bottom: 1px solid #e0e0e0;
        }
        .modal-product-table th, .modal-product-table td {
            vertical-align: middle;
        }
        /* END Order History CSS */
    </style>
</head>
<body>
<div class="settings-container">
    <a th:href="@{/}" class="btn btn-sm btn-secondary mb-3">
        <i class="fas fa-home"></i> Về Trang chủ
    </a>

    <div class="settings-card">
        <h3 class="mb-4" style="color: #2c3e50;"><i class="fas fa-cog me-2"></i> Cài đặt Tài khoản</h3>

        <ul class="nav nav-pills mb-4" id="settingTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="profile-tab" data-bs-toggle="pill" data-bs-target="#profile-settings" type="button" role="tab" aria-controls="profile-settings" aria-selected="true">
                    <i class="fas fa-user me-2"></i> Hồ sơ Cá nhân
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="security-tab" data-bs-toggle="pill" data-bs-target="#security-settings" type="button" role="tab" aria-controls="security-settings" aria-selected="false">
                    <i class="fas fa-lock me-2"></i> Đổi Mật Khẩu
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="address-tab" data-bs-toggle="pill" data-bs-target="#address-settings" type="button" role="tab" aria-controls="address-settings" aria-selected="false">
                    <i class="fas fa-map-marker-alt me-2"></i> Thiết Lập Địa Chỉ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" data-bs-toggle="pill" data-bs-target="#orders-settings" type="button" role="tab" aria-controls="orders-settings" aria-selected="false">
                    <i class="fas fa-box me-2"></i> Đơn Hàng
                </button>
            </li>
        </ul>

        <div class="tab-content" id="settingsTabContent">

            <div class="tab-pane fade show active" id="profile-settings" role="tabpanel" aria-labelledby="profile-tab">
                <h5 class="mb-3">Thông tin Cá nhân</h5>

                <div th:if="${profileError}" class="alert alert-danger alert-dismissible fade show text-center" role="alert">
                    <span th:text="${profileError}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${profileSuccess}" class="alert alert-success alert-dismissible fade show text-center" role="alert">
                    <span th:text="${profileSuccess}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <form th:action="@{/user/profile/update}" method="post" id="profileForm">
                    <input type="hidden" name="idUser" th:if="${currentUser}" th:value="${currentUser.idUser}">

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="username" class="form-label">Họ tên (Username)</label>
                            <input type="text" class="form-control" id="username" name="username" th:value="${currentUser.username}" required readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" th:value="${currentUser.email}" required readonly>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="phone" class="form-label">Điện thoại</label>
                            <input type="tel" class="form-control" id="phone" name="phone" th:value="${currentUser.phone}" required readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="gender" class="form-label">Giới tính</label>
                            <select class="form-select" id="gender" name="gender" required disabled>
                                <option value="Male" th:selected="${currentUser.gender == 'Male'}">Nam</option>
                                <option value="Female" th:selected="${currentUser.gender == 'Female'}">Nữ</option>
                                <option value="Other" th:selected="${currentUser.gender == 'Other'}">Khác</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Cập nhật lần cuối</label>
                            <input type="text" class="form-control" th:value="${currentUser.updateDate}" readonly>
                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary" id="editButton" onclick="toggleEdit(true)">
                            <i class="fas fa-edit"></i> Chỉnh sửa
                        </button>
                        <button type="submit" class="btn btn-custom-primary" id="saveButton" style="display: none;">
                            <i class="fas fa-save"></i> Lưu thay đổi
                        </button>
                        <button type="button" class="btn btn-danger" id="cancelButton" onclick="toggleEdit(false)" style="display: none;">
                            <i class="fas fa-times"></i> Hủy
                        </button>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade" id="security-settings" role="tabpanel" aria-labelledby="security-tab">
                <h5 class="mb-3">Thay đổi Mật khẩu</h5>

                <div th:if="${securityError}" class="alert alert-danger alert-dismissible fade show text-center" role="alert">
                    <span th:text="${securityError}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${securitySuccess}" class="alert alert-success alert-dismissible fade show text-center" role="alert">
                    <span th:text="${securitySuccess}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <form th:action="@{/user/setting/change-password}" method="post">
                    <div class="mb-3 password-container">
                        <label for="currentPassword" class="form-label">Mật khẩu hiện tại</label>
                        <input type="password" class="form-control" id="currentPassword" name="currentPassword" required>
                        <i class="fas fa-eye toggle-password" data-target="currentPassword"></i>
                    </div>
                    <div class="mb-3 password-container">
                        <label for="newPassword" class="form-label">Mật khẩu mới</label>
                        <input type="password" class="form-control" id="newPassword" name="newPassword" required minlength="6">
                        <i class="fas fa-eye toggle-password" data-target="newPassword"></i>
                        <div class="form-text">Mật khẩu nên có ít nhất 6 ký tự.</div>
                    </div>
                    <div class="mb-4 password-container">
                        <label for="confirmPassword" class="form-label">Xác nhận mật khẩu mới</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required>
                        <i class="fas fa-eye toggle-password" data-target="confirmPassword"></i>
                    </div>
                    <button type="submit" class="btn btn-custom-primary"><i class="fas fa-key me-2"></i> Cập nhật Mật khẩu</button>
                </form>
            </div>

            <div class="tab-pane fade" id="address-settings" role="tabpanel" aria-labelledby="address-tab" tabindex="0">
                <h5 class="mb-3">Quản lý Địa chỉ Giao hàng</h5>

                <div th:if="${addressError}" class="alert alert-danger alert-dismissible fade show text-center mb-3" role="alert">
                    <span th:text="${addressError}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${addressSuccess}" class="alert alert-success alert-dismissible fade show text-center mb-3" role="alert">
                    <span th:text="${addressSuccess}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white"><i class="fas fa-plus-square me-2"></i>Thêm Địa chỉ Mới</div>
                    <div class="card-body">
                        <form th:action="@{/user/address/add}" method="post">
                            <div class="mb-3">
                                <label for="newAddressDetail" class="form-label">Địa chỉ Chi tiết (Số nhà, đường, khu vực) <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="newAddressDetail" name="fullAddressDetail" rows="3"
                                          placeholder="Ví dụ: Số 123, Đường Xuân Thủy, Phường Dịch Vọng Hậu, Quận Cầu Giấy, Hà Nội"
                                          th:text="${newAddressDetail}" required></textarea>
                            </div>
                            <div class="mb-4">
                                <label for="newAddressPhone" class="form-label">Số điện thoại nhận hàng <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="newAddressPhone" name="phone"
                                       placeholder="Số điện thoại" th:value="${newAddressPhone}" required>
                            </div>
                            <button type="submit" class="btn btn-custom-primary">
                                <i class="fas fa-save"></i> Lưu Địa chỉ
                            </button>
                        </form>
                    </div>
                </div>

                <h5 class="mt-4 mb-3">Địa chỉ đã lưu (<span th:text="${userAddresses != null ? userAddresses.size() : 0}">0</span>)</h5>

                <div th:if="${userAddresses == null || userAddresses.isEmpty()}" class="alert alert-warning small">
                    <i class="fas fa-exclamation-circle"></i> Bạn chưa có địa chỉ nào được lưu.
                </div>

                <div th:each="address, stat : ${userAddresses}" class="card mb-3 address-item"
                     th:classappend="${stat.index == 0} ? 'border-success shadow-sm' : 'border-light'">

                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <p class="mb-1 fw-bold">
                                    <i class="fas fa-map-marker-alt me-2 text-danger"></i>
                                    <span th:text="${stat.index + 1} + '. ' + ${address.getFullAddressDetail()}"></span>
                                    <span th:if="${stat.index == 0}" class="badge bg-success ms-2">MẶC ĐỊNH</span>
                                </p>
                                <p class="mb-0 small text-muted">
                                    <i class="fas fa-phone me-2"></i> ĐT: <span th:text="${address.getPhone()}"></span>
                                </p>
                            </div>
                            <div>
                                <form th:action="@{'/user/address/delete/' + ${address.getIdAddress()}}" method="post"
                                      onsubmit="return confirmDelete(event)"
                                      style="display: inline;">

                                    <button type="submit" class="btn btn-sm btn-outline-danger ms-2" title="Xóa địa chỉ">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="orders-settings" role="tabpanel" aria-labelledby="orders-tab" tabindex="0">
                <h3 class="mb-4 text-primary"><i class="fas fa-history"></i> Lịch sử Đơn hàng của bạn</h3>

                <div th:if="${error}" class="alert alert-danger" role="alert">
                    <span th:text="${error}"></span>
                </div>

                <div id="loading" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Đang tải đơn hàng...</p>
                </div>

                <div id="ordersList" class="row">
                </div>

                <div id="noOrders" class="alert alert-info text-center d-none p-5">
                    <i class="fas fa-box-open fa-3x mb-3"></i>
                    <h4>Bạn chưa có đơn hàng nào.</h4>
                    <p>Hãy bắt đầu mua sắm ngay!</p>
                </div>

                <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="orderDetailModalLabel">
                                    Chi tiết Đơn hàng: <span id="modalOrderCode">#DH000</span>
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-lg-5">
                                        <h6 class="text-secondary"><i class="fas fa-info-circle me-1"></i> Thông tin chung</h6>
                                        <ul class="list-group list-group-flush mb-3">
                                            <li class="list-group-item"><strong>Trạng thái:</strong> <span id="modalStatus" class="status-badge"></span></li>
                                            <li class="list-group-item"><strong>Ngày đặt:</strong> <span id="modalDate"></span></li>
                                            <li class="list-group-item"><strong>Khách hàng:</strong> <span id="modalCustomer"></span></li>
                                            <li class="list-group-item"><strong>Điện thoại:</strong> <span id="modalPhone"></span></li>
                                            <li class="list-group-item"><strong>Thanh toán:</strong> <span id="modalPayment"></span></li>
                                            <li class="list-group-item"><strong>Địa chỉ:</strong> <span id="modalAddress"></span></li>
                                            <li class="list-group-item"><strong>Ghi chú:</strong> <span id="modalNote" class="fst-italic text-muted"></span></li>
                                        </ul>
                                    </div>

                                    <div class="col-lg-7">
                                        <h6 class="text-secondary"><i class="fas fa-file-invoice-dollar me-1"></i> Tổng kết</h6>
                                        <ul class="list-group list-group-flush mb-3">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <strong>Tổng tiền hàng:</strong>
                                                <span id="modalSubTotal"></span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between text-success">
                                                <strong>Giảm giá Voucher:</strong>
                                                <span>- <span id="modalVoucherDiscount">0đ</span></span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <strong>Phí vận chuyển:</strong>
                                                <span>Miễn phí</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between bg-light fw-bold">
                                                <h4>Tổng thanh toán:</h4>
                                                <h4 class="text-danger" id="modalTotalAmount"></h4>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <hr>

                                <h6 class="text-secondary mb-3"><i class="fas fa-boxes me-1"></i> Sản phẩm trong đơn hàng (<span id="modalTotalProducts"></span>)</h6>
                                <div class="table-responsive">
                                    <table class="table table-bordered modal-product-table">
                                        <thead>
                                        <tr class="table-primary">
                                            <th>#</th>
                                            <th>Tên sản phẩm</th>
                                            <th>Tác giả</th>
                                            <th>Giá bán</th>
                                            <th>SL</th>
                                            <th>Thành tiền</th>
                                        </tr>
                                        </thead>
                                        <tbody id="modalProductDetailsBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    let originalData = {};

    document.addEventListener('DOMContentLoaded', () => {
        if (window.location.hash) {
            // Tự động chuyển tab dựa trên hash hoặc thông báo
            autoSwitchTabs();
            setTimeout(function() {
                window.scrollTo(0, 0);
            }, 1);
        }

        if (document.getElementById('username')) {
            originalData = {
                username: document.getElementById('username').value,
                phone: document.getElementById('phone').value,
                gender: document.getElementById('gender').value
            };
        }
        toggleEdit(false);

        // Logic để tải đơn hàng khi tab được hiển thị
        const ordersTabElement = document.getElementById('orders-tab');
        if (ordersTabElement) {
            ordersTabElement.addEventListener('show.bs.tab', function (event) {
                fetchOrders();
            });
        }

        // Nếu tab đơn hàng là tab được kích hoạt ngay khi load trang, gọi fetchOrders
        const activeTabId = autoSwitchTabs();
        if (activeTabId === 'orders-settings') {
            fetchOrders();
        }
    });

    function toggleEdit(isEditing) {
        const editableFields = ['username', 'phone'];
        const genderField = document.getElementById('gender');
        const editButton = document.getElementById('editButton');
        const saveButton = document.getElementById('saveButton');
        const cancelButton = document.getElementById('cancelButton');

        editableFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.readOnly = !isEditing;
        });
        if (genderField) genderField.disabled = !isEditing;

        if (isEditing) {
            if (editButton) editButton.style.display = 'none';
            if (saveButton) saveButton.style.display = 'inline-block';
            if (cancelButton) cancelButton.style.display = 'inline-block';
        } else {
            if (document.getElementById('username') && originalData.username !== undefined) {
                document.getElementById('username').value = originalData.username;
                document.getElementById('phone').value = originalData.phone;
                document.getElementById('gender').value = originalData.gender;
            }

            if (editButton) editButton.style.display = 'inline-block';
            if (saveButton) saveButton.style.display = 'none';
            if (cancelButton) cancelButton.style.display = 'none';
        }
    }

    // Logic client-side validation trước khi submit Profile
    if (document.getElementById('profileForm')) {
        document.getElementById('profileForm').addEventListener('submit', function(event) {
            const phone = document.getElementById('phone').value.trim();
            const username = document.getElementById('username').value.trim();

            if (username.length < 5) {
                alert('Họ tên (Username) phải có ít nhất 5 ký tự.');
                event.preventDefault();
                return;
            }

            const phoneRegex = /^[0-9]{10,11}$/;
            if (!phoneRegex.test(phone)) {
                alert('Số điện thoại không hợp lệ (phải là 10 hoặc 11 chữ số).');
                event.preventDefault();
            }
        });
    }

    // --- Logic Toggle Password ---
    document.querySelectorAll('.toggle-password').forEach(icon => {
        icon.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const targetInput = document.getElementById(targetId);
            const type = targetInput.getAttribute('type') === 'password' ? 'text' : 'password';
            targetInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
        });
    });

    function autoSwitchTabs() {
        let targetTabId = 'profile-settings';

        const urlHash = window.location.hash;
        if (urlHash && urlHash.startsWith('#')) {
            targetTabId = urlHash.substring(1);
        }
        else {
            const isProfileNotif = document.querySelector('#profile-settings .alert-danger') || document.querySelector('#profile-settings .alert-success');
            const isSecurityNotif = document.querySelector('#security-settings .alert-danger') || document.querySelector('#security-settings .alert-success');
            const isAddressNotif = document.querySelector('#address-settings .alert-danger') || document.querySelector('#address-settings .alert-success');
            // Kiểm tra thông báo trên tab đơn hàng (nếu có)
            const isOrdersNotif = document.querySelector('#orders-settings .alert-danger') || document.querySelector('#orders-settings .alert-success');

            if (isSecurityNotif) {
                targetTabId = 'security-settings';
            } else if (isAddressNotif) {
                targetTabId = 'address-settings';
            } else if (isOrdersNotif) {
                targetTabId = 'orders-settings';
            } else if (isProfileNotif) {
                targetTabId = 'profile-settings';
            }
        }

        const targetTabElement = document.getElementById(targetTabId);

        if (targetTabElement) {
            const tabElement = document.getElementById(targetTabId.replace('-settings', '-tab'));
            if (tabElement) {
                const tab = new bootstrap.Tab(tabElement);
                tab.show();
                return targetTabId; // Trả về ID tab được chọn
            }
        }
        return 'profile-settings'; // Mặc định
    }

    // --- Logic Xóa Địa chỉ (CẢI TIẾN) ---
    function confirmDelete(event) {
        const message = "Bạn có chắc chắn muốn xóa địa chỉ này không?\n\nLƯU Ý QUAN TRỌNG:\nĐịa chỉ này KHÔNG THỂ xóa nếu nó đã được sử dụng trong bất kỳ đơn hàng nào của bạn. Hệ thống sẽ báo lỗi để đảm bảo tính toàn vẹn dữ liệu đơn hàng.";

        if (!confirm(message)) {
            event.preventDefault(); // Ngăn form submit nếu người dùng chọn Hủy
            return false;
        }

        return true;
    }

    const USER_ID = /*[[${currentUser.idUser}]]*/ null;

    if (USER_ID === null || USER_ID === 0) {
        console.error("Lỗi: Không thể lấy ID người dùng hiện tại từ Server.");
    }

    const API_URL = `/api/users/${USER_ID}/orders`;
    const DETAIL_API_URL = '/api/orders/detail/';

    function formatPrice(price) {
        if (typeof price !== 'number' || price < 0) price = 0;
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
    }

    function getStatusLabel(status) {
        switch (status) {
            case 'PENDING': return 'Chờ xác nhận';
            case 'CONFIRMED': return 'Đã xác nhận';
            case 'SHIPPING': return 'Đang vận chuyển';
            case 'DELIVERED': return 'Đã giao hàng';
            case 'CANCELLED': return 'Đã hủy';
            default: return status;
        }
    }

    function redirectToReview(orderId, productDetails) {
        if (productDetails && productDetails.length > 0) {
            alert(`Chuyển hướng đến trang đánh giá cho Đơn hàng #${orderId}.`);
        } else {
            alert(`Đơn hàng #${orderId} không có chi tiết sản phẩm để đánh giá.`);
        }
    }

    function renderOrders(orders) {
        const ordersListDiv = document.getElementById('ordersList');
        const noOrdersDiv = document.getElementById('noOrders');
        ordersListDiv.innerHTML = '';

        if (!orders || orders.length === 0) {
            noOrdersDiv.classList.remove('d-none');
            return;
        }

        noOrdersDiv.classList.add('d-none');

        orders.forEach(order => {
            const statusLabel = getStatusLabel(order.status);
            const details = order.productDetails || [];

            const visibleItems = details.slice(0, 2);
            const remainingItemsCount = details.length - visibleItems.length;

            let itemsHtml = visibleItems.map(item => `
                    <div class="d-flex justify-content-between text-muted ms-3">
                        <span class="text-truncate" style="max-width: 80%;">${item.productName} (x${item.quantity})</span>
                        <span class="fw-bold">${item.priceAtDateFormatted}</span>
                    </div>
                `).join('');

            if (remainingItemsCount > 0) {
                itemsHtml += `<p class="text-muted fst-italic ms-3 mt-1 mb-0">+ ${remainingItemsCount} sản phẩm khác</p>`;
            } else if (details.length === 0) {
                itemsHtml = `<p class="text-muted fst-italic ms-3 mt-1 mb-0">Không có chi tiết sản phẩm.</p>`;
            }

            let actionButtons = `
                    <button class="btn btn-sm btn-outline-primary" onclick="showOrderDetails(${order.idOrder})">
                        <i class="fas fa-eye"></i> Xem chi tiết
                    </button>
                `;

            if (order.status === 'DELIVERED') {
                actionButtons += `
                        <button class="btn btn-sm btn-success ms-2" onclick='redirectToReview(${order.idOrder}, ${JSON.stringify(details)})'>
                            <i class="fas fa-star"></i> Đánh giá
                        </button>
                    `;
            } else if (order.status === 'PENDING' || order.status === 'CONFIRMED') {
                actionButtons += `
                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="cancelOrder(${order.idOrder})">
                            <i class="fas fa-times-circle"></i> Hủy đơn
                        </button>
                    `;
            }

            const orderCard = `
                    <div class="col-lg-12 col-xl-6">
                        <div class="card order-card">
                            <div class="card-header order-header d-flex justify-content-between align-items-center bg-white p-3">
                                <h5 class="mb-0 text-primary fw-bold">${order.orderCode}</h5>
                                <span class="status-badge ${order.status}">${statusLabel}</span>
                            </div>
                            <div class="card-body p-3">
                                <p class="mb-1"><strong>Ngày đặt:</strong> ${order.dateFormatted}</p>
                                <p class="mb-1"><strong>Tổng tiền:</strong> <span class="text-danger fw-bold">${order.totalAmountFormatted}</span></p>
                                <p class="mb-2"><strong>Địa chỉ:</strong> ${order.address || 'N/A'}</p>

                                <hr class="my-2">
                                <h6>Chi tiết sản phẩm (${order.totalProducts} cuốn):</h6>
                                ${itemsHtml}
                            </div>
                            <div class="card-footer bg-white p-3 text-end">
                                ${actionButtons}
                            </div>
                        </div>
                    </div>
                `;
            ordersListDiv.insertAdjacentHTML('beforeend', orderCard);
        });
    }

    async function fetchOrders() {
        document.getElementById('loading').classList.remove('d-none');
        document.getElementById('noOrders').classList.add('d-none');
        document.getElementById('ordersList').innerHTML = '';

        if (USER_ID === null || USER_ID === 0) {
            document.getElementById('loading').classList.add('d-none');
            // Hiển thị lỗi bảo mật nếu không có ID
            document.getElementById('noOrders').innerHTML = '<h4 class="text-danger">Lỗi bảo mật: Không thể xác định tài khoản. Vui lòng đăng nhập lại.</h4>';
            document.getElementById('noOrders').classList.remove('d-none');
            return;
        }

        try {
            const response = await fetch(API_URL);
            if (!response.ok) {
                throw new Error(`Lỗi HTTP: ${response.status} khi tải lịch sử đơn hàng.`);
            }
            const orders = await response.json();
            renderOrders(orders);
        } catch (error) {
            console.error(error);
            alert('Không thể tải lịch sử đơn hàng. Vui lòng thử lại.');
            document.getElementById('noOrders').classList.remove('d-none');
        } finally {
            document.getElementById('loading').classList.add('d-none');
        }
    }

    async function showOrderDetails(orderId) {
        const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
        const modalTitle = document.getElementById('modalOrderCode');
        const modalBody = document.getElementById('modalProductDetailsBody');

        modalTitle.textContent = `#DH${orderId}`;
        modalBody.innerHTML = '<tr><td colspan="6" class="text-center">Đang tải chi tiết...</td></tr>';

        modal.show();

        try {
            const response = await fetch(DETAIL_API_URL + orderId);
            if (!response.ok) {
                throw new Error(`Lỗi HTTP: ${response.status}`);
            }
            const detailData = await response.json();

            fillModalContent(detailData);

        } catch (error) {
            console.error("Lỗi tải chi tiết đơn hàng:", error);
            modalBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Lỗi: Không thể tải chi tiết đơn hàng này.</td></tr>';
        }
    }

    function fillModalContent(data) {
        // --- Thông tin chung ---
        document.getElementById('modalOrderCode').textContent = data.orderCode;
        document.getElementById('modalStatus').textContent = getStatusLabel(data.status);
        document.getElementById('modalStatus').className = `status-badge ${data.status}`;
        document.getElementById('modalDate').textContent = data.dateFormatted;
        document.getElementById('modalCustomer').textContent = data.customerUsername;
        document.getElementById('modalPhone').textContent = data.customerPhone;
        document.getElementById('modalPayment').textContent = data.paymentMethod;
        document.getElementById('modalAddress').textContent = data.address || 'Không có';
        document.getElementById('modalNote').textContent = data.note || 'Không có ghi chú';

        // --- Tổng kết ---
        document.getElementById('modalTotalAmount').textContent = data.totalAmountFormatted;
        document.getElementById('modalSubTotal').textContent = data.totalAmountFormatted;
        document.getElementById('modalVoucherDiscount').textContent = '0đ';
        document.getElementById('modalTotalProducts').textContent = data.totalProducts;

        // --- Chi tiết sản phẩm ---
        const detailsBody = document.getElementById('modalProductDetailsBody');
        detailsBody.innerHTML = '';

        if (data.productDetails && data.productDetails.length > 0) {
            data.productDetails.forEach((item, index) => {
                const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.productName}</td>
                            <td>${item.productAuthor || 'N/A'}</td>
                            <td>${item.priceAtDateFormatted}</td>
                            <td>${item.quantity}</td>
                            <td><strong class="text-danger">${formatPrice(item.priceAtDate * item.quantity)}</strong></td>
                        </tr>
                    `;
                detailsBody.insertAdjacentHTML('beforeend', row);
            });
        } else {
            detailsBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Không có chi tiết sản phẩm.</td></tr>';
        }
    }


    function cancelOrder(orderId) {
        if(confirm(`Bạn có chắc chắn muốn hủy đơn hàng #${orderId} không? Việc này không thể hoàn tác.`)) {
            alert(`Yêu cầu hủy đơn hàng #${orderId} đã được gửi.`);
            fetchOrders();
        }
    }

</script>
</body>
</html>