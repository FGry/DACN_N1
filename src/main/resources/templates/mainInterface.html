<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookStore - C·ª≠a h√†ng s√°ch h·ªçc t·∫≠p</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS C≈® ƒê∆Ø·ª¢C GI·ªÆ NGUY√äN */
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
            color: white !important;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-link:hover {
            color: white !important;
        }

        .btn-auth {
            background-color: transparent;
            border: 1px solid white;
            color: white;
            padding: 5px 15px;
            margin: 0 5px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .btn-auth:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .cart-icon {
            margin-left: 15px;
            color: white;
            font-size: 1.2rem;
            position: relative;
            cursor: pointer;
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hero-banner {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 60px 0;
            margin-bottom: 40px;
        }

        .hero-content h1 {
            color: #2c3e50;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .hero-content p {
            color: #34495e;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .category-section {
            margin: 40px 0;
        }

        .category-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .category-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        /* START: S·ª¨A CSS CƒÇN CH·ªàNH TH·∫∫ S·∫¢N PH·∫®M */
        .product-card {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .product-image {
            height: 250px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: #e67e22;
        }

        .product-image img {
            height: 100%;
            width: 100%;
            object-fit: contain;
            padding: 10px;
        }

        .product-info {
            display: flex;
            flex-direction: column;
            min-height: 180px;
            padding: 20px;
            flex-grow: 1;
        }

        .product-title {
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .product-info .text-muted {
            height: 36px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .product-price {
            margin-top: auto;
            color: #e74c3c;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }
        /* END: S·ª¨A CSS CƒÇN CH·ªàNH TH·∫∫ S·∫¢N PH·∫®M */

        .btn-add-cart {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-add-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }

        .btn-order {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .btn-order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .search-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin: 40px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .search-input {
            border: 2px solid #e9ecef;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 1rem;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .btn-search {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 25px;
            color: white;
            font-weight: 600;
        }

        .footer {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 40px 0 20px 0;
            margin-top: 60px;
        }

        .voucher-banner {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        /* CSS cho Modal Cart Chi Ti·∫øt */
        #cartModal .modal-body img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            border-radius: 5px;
            margin-right: 15px;
            border: 1px solid #eee;
        }
        #cartModal .modal-body .cart-item-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        #cartModal .modal-body .cart-item-detail:last-child {
            border-bottom: none;
        }
        /* TH√äM CSS CURSOR CHO T√äN S·∫¢N PH·∫®M TRONG MODAL */
        #cartModal .item-title-link {
            cursor: pointer;
            color: #343a40;
            text-decoration: none;
        }
        #cartModal .item-title-link:hover {
            color: #667eea;
            text-decoration: underline;
        }


        @media (max-width: 768px) {
            .hero-banner {
                padding: 40px 0;
            }

            .hero-content h1 {
                font-size: 2rem;
            }

            .product-image {
                height: 200px;
                font-size: 3rem;
            }

            .category-card {
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}" href="#"><i class="fas fa-book-open"></i> BookStore</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="#home">Trang ch·ªß</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/products}">S·∫£n ph·∫©m</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/about}">Gi·ªõi thi·ªáu</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/contact}">Li√™n h·ªá</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{user/voucher}">Voucher</a>
                </li>
            </ul>

            <div class="d-flex align-items-center" id="authButtons">

                <div id="loggedOutButtons" th:if="${!isLoggedIn}">
                    <a th:href="@{/login}" href="login.html" class="btn btn-auth btn-sm">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                    </a>
                    <a th:href="@{/register}" href="register.html" class="btn btn-auth btn-sm">
                        <i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω
                    </a>
                </div>

                <div id="loggedInButtons" th:if="${isLoggedIn}">
                    <div class="dropdown">
                        <button class="btn btn-auth btn-sm dropdown-toggle" type="button" id="userMenu" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle"></i>
                            <span id="userNameDisplay" th:text="${currentUser.username}">T√†i kho·∫£n</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                            <li><a class="dropdown-item" th:href="@{/user/profile}">
                                <i class="fas fa-info-circle"></i> Th√¥ng tin c√° nh√¢n
                            </a></li>

                            <li><a class="dropdown-item" th:href="@{/user/profile#address-settings}">
                                <i class="fas fa-map-marked-alt"></i> C·∫≠p nh·∫≠t ƒê·ªãa ch·ªâ
                            </a></li>

                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" th:href="@{/logout}">
                                <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                            </a></li>
                        </ul>
                    </div>
                </div>

                <div class="cart-icon ms-3" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#cartModal">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-badge" id="cartCount">0</span>
                </div>
            </div>
        </div>
    </div>
</nav>

<section class="hero-banner" id="home">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <div class="hero-content">
                    <h1>Kh√°m ph√° th·∫ø gi·ªõi tri th·ª©c</h1>
                    <p>C·ª≠a h√†ng s√°ch h·ªçc t·∫≠p h√†ng ƒë·∫ßu d√†nh cho h·ªçc sinh, sinh vi√™n. Ch√∫ng t√¥i cung c·∫•p ƒë·∫ßy ƒë·ªß s√°ch gi√°o khoa, s√°ch tham kh·∫£o v√† t√†i li·ªáu h·ªçc t·∫≠p ch·∫•t l∆∞·ª£ng cao.</p>
                    <a th:href="@{/products}" class="btn btn-primary-custom">
                        <i class="fas fa-book"></i> Kh√°m ph√° ngay
                    </a>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="text-center">
                    <i class="fas fa-graduation-cap" style="font-size: 8rem; color: #667eea; opacity: 0.8;"></i>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="container">
    <div class="voucher-banner" id="voucher">
        <h3><i class="fas fa-gift"></i> ∆Øu ƒë√£i ƒë·∫∑c bi·ªát!</h3>
        <p class="mb-2">Gi·∫£m 20% cho ƒë∆°n h√†ng ƒë·∫ßu ti√™n - M√£: <strong>HOCSINH20</strong></p>
        <small>√Åp d·ª•ng cho t·∫•t c·∫£ s√°ch gi√°o khoa v√† tham kh·∫£o</small>
    </div>
</div>

<div class="container">
    <div class="search-section">
        <h4 class="text-center mb-4"><i class="fas fa-search"></i> T√¨m ki·∫øm s√°ch</h4>
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="input-group">
                    <input type="text" class="form-control search-input" id="searchInput" placeholder="Nh·∫≠p t√™n s√°ch c·∫ßn t√¨m...">
                    <button class="btn btn-search" onclick="searchBooks()">
                        <i class="fas fa-search"></i> T√¨m ki·∫øm
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container category-section text-center">
    <h2 class="mb-5">Danh m·ª•c s√°ch</h2>

    <div class="row justify-content-center">
        <div class="col-lg-3 col-md-4 col-sm-6 mb-4" th:each="category : ${allCategories}">
            <div class="category-card" th:onclick="|filterByCategory(${category.id_categories})|">
                <div class="category-icon"><i class="fas fa-book"></i></div> <h5 th:text="${category.name}">T√™n danh m·ª•c</h5>
                <p class="text-muted" th:text="${category.description}">M√¥ t·∫£ danh m·ª•c...</p>
            </div>
        </div>
    </div>
    <div class="col-12 mt-4 text-center" th:if="${allCategories != null and !allCategories.isEmpty()}">
        <a th:href="@{/products#products}" class="btn btn-primary-custom">
            <i class="fas fa-list"></i> Xem t·∫•t c·∫£ s·∫£n ph·∫©m
        </a>
    </div>
</div>


<div class="container" id="featured-products">
    <h2 class="text-center mb-5">S·∫£n ph·∫©m n·ªïi b·∫≠t</h2>
    <div class="row" id="productList">
        <div th:if="${products == null || products.isEmpty()}" class="col-12 text-center">
            <div class="alert alert-info">
                <strong>Th√¥ng b√°o:</strong> Hi·ªán ch∆∞a c√≥ s·∫£n ph·∫©m n·ªïi b·∫≠t n√†o ƒë·ªÉ hi·ªÉn th·ªã.
            </div>
        </div>
    </div>
</div>
<div class="container" id="all-products" style="margin-top: 50px;">
    <h2 class="text-center mb-5"><i class="fas fa-store"></i> T·∫•t c·∫£ s·∫£n ph·∫©m</h2>
    <div class="row" id="allProductList">
        <div th:if="${allProductsForHome == null || allProductsForHome.isEmpty()}" class="col-12 text-center">
            <div class="alert alert-info">
                <strong>Th√¥ng b√°o:</strong> C·ª≠a h√†ng hi·ªán ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.
            </div>
        </div>
    </div>
    <nav class="d-flex justify-content-center mt-5" id="pagination-container">
    </nav>
</div>
<div class="container" id="about" style="margin-top: 60px;">
    <div class="row">
        <div class="col-lg-8 mx-auto text-center">
            <h2 class="mb-4">V·ªÅ ch√∫ng t√¥i</h2>
            <p class="lead">BookStore l√† c·ª≠a h√†ng s√°ch tr·ª±c tuy·∫øn chuy√™n cung c·∫•p s√°ch h·ªçc t·∫≠p ch·∫•t l∆∞·ª£ng cao d√†nh cho h·ªçc sinh, sinh vi√™n. Ch√∫ng t√¥i cam k·∫øt mang ƒë·∫øn nh·ªØng cu·ªën s√°ch hay nh·∫•t, gi√° c·∫£ h·ª£p l√Ω v√† d·ªãch v·ª• t·∫≠n t√¢m.</p>
        </div>
    </div>
</div>

<footer class="footer" id="contact">
    <div class="container">
        <div class="row">
            <div class="col-md-4">
                <h5><i class="fas fa-book-open"></i> BookStore</h5>
                <p>C·ª≠a h√†ng s√°ch h·ªçc t·∫≠p h√†ng ƒë·∫ßu cho h·ªçc sinh c·∫•p 3</p>
            </div>
            <div class="col-md-4">
                <h5>Li√™n h·ªá</h5>
                <p><i class="fas fa-phone"></i> 0123 456 789</p>
                <p><i class="fas fa-envelope"></i> info@bookstore.vn</p>
                <p><i class="fas fa-map-marker-alt"></i> 123 ƒê∆∞·ªùng ABC, TP.HCM</p>
            </div>
            <div class="col-md-4">
                <h5>Theo d√µi ch√∫ng t√¥i</h5>
                <div class="d-flex">
                    <a href="#" class="text-white me-3"><i class="fab fa-facebook fa-2x"></i></a>
                    <a href="#" class="text-white me-3"><i class="fab fa-instagram fa-2x"></i></a>
                    <a href="#" class="text-white"><i class="fab fa-youtube fa-2x"></i></a>
                </div>
            </div>
        </div>
        <hr class="my-4">
        <div class="text-center">
            <p>&copy; 2024 BookStore. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        </div>
    </div>
</footer>

<div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-shopping-cart"></i> Gi·ªè h√†ng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cartItems">
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <h5>T·ªïng c·ªông: <span id="totalPrice">0ƒë</span></h5>
                    <a th:href="@{/user/cart}" href="/user/cart" id="checkoutBtn" class="btn btn-primary-custom disabled">
                        <i class="fas fa-credit-card"></i> Thanh to√°n (ƒêi ƒë·∫øn gi·ªè h√†ng)
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Chi ti·∫øt s·∫£n ph·∫©m</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productModalBody">
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="userInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-user-circle"></i> Th√¥ng tin c√° nh√¢n</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="userInfoContent">
                    <p class="text-center text-muted">ƒêang t·∫£i...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    // --- 1. KHAI B√ÅO D·ªÆ LI·ªÜU S·∫¢N PH·∫®M ---
    // S·∫¢N PH·∫®M N·ªîI B·∫¨T (danh s√°ch ƒë√£ l·ªçc 4 s·∫£n ph·∫©m)
    const featuredProductsFromController = /*[[${products}]]*/ [];
    // T·∫§T C·∫¢ S·∫¢N PH·∫®M (Gi·∫£ ƒë·ªãnh Controller truy·ªÅn TO√ÄN B·ªò danh s√°ch)
    const allProductsData = /*[[${allProductsForHome}]]*/ []; // T√™n bi·∫øn n√†y s·∫Ω ƒë∆∞·ª£c ƒë·ªïi th√†nh allProductsData

    // --- LOGIC PH√ÇN TRANG FRONTEND ---
    const productsPerPage = 12;
    let currentPage = 1;
    let totalPages = 0;


    // D·ªØ li·ªáu m·∫´u (s·ª≠ d·ª•ng khi Controller kh√¥ng g·ª≠i d·ªØ li·ªáu)
    const mockProducts = [
        // ... (13 mock products nh∆∞ trong y√™u c·∫ßu tr∆∞·ªõc)
        { id: 1, idProducts: 1, title: "To√°n h·ªçc 12 - S√°ch gi√°o khoa", price: 45000, description: "S√°ch gi√°o khoa To√°n h·ªçc l·ªõp 12, ch∆∞∆°ng tr√¨nh m·ªõi", icon: "üìö", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=T12']},
        { id: 2, idProducts: 2, title: "V·∫≠t l√Ω 11 - B√†i t·∫≠p n√¢ng cao", price: 65000, description: "B·ªô s√°ch b√†i t·∫≠p V·∫≠t l√Ω n√¢ng cao v·ªõi nhi·ªÅu d·∫°ng b√†i hay", icon: "‚ö°", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=L11']},
        { id: 3, idProducts: 3, title: "English Grammar in Use", price: 120000, description: "S√°ch ng·ªØ ph√°p ti·∫øng Anh c∆° b·∫£n ƒë·∫øn n√¢ng cao", icon: "üá¨üáß", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=ENG']},
        { id: 4, idProducts: 4, title: "H√≥a h·ªçc 10 - S√°ch gi√°o khoa", price: 42000, description: "S√°ch gi√°o khoa H√≥a h·ªçc l·ªõp 10, ch∆∞∆°ng tr√¨nh chu·∫©n", icon: "üß™", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=H10']},
        { id: 5, idProducts: 5, title: "Sinh h·ªçc 12", price: 50000, description: "S√°ch gi√°o khoa Sinh h·ªçc l·ªõp 12", icon: "üß¨", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=B12']},
        { id: 6, idProducts: 6, title: "Luy·ªán thi IELTS", price: 200000, description: "B·ªô s√°ch luy·ªán thi IELTS 4 k·ªπ nƒÉng", icon: "üìù", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=IELTS']},
        { id: 7, idProducts: 7, title: "VƒÉn h·ªçc 10 - T·∫≠p 1", price: 38000, description: "S√°ch gi√°o khoa VƒÉn h·ªçc l·ªõp 10", icon: "üìú", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=V10']},
        { id: 8, idProducts: 8, title: "L·ªãch s·ª≠ Th·∫ø gi·ªõi", price: 75000, description: "S√°ch tham kh·∫£o L·ªãch s·ª≠ Th·∫ø gi·ªõi", icon: "üï∞Ô∏è", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=HIS']},
        { id: 9, idProducts: 9, title: "K·ªπ nƒÉng qu·∫£n l√Ω th·ªùi gian", price: 90000, description: "S√°ch k·ªπ nƒÉng s·ªëng gi√∫p qu·∫£n l√Ω th·ªùi gian hi·ªáu qu·∫£", icon: "‚è∞", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=TIME']},
        { id: 10, idProducts: 10, title: "Ti·∫øng Anh giao ti·∫øp A2", price: 110000, description: "S√°ch h·ªçc ti·∫øng Anh giao ti·∫øp tr√¨nh ƒë·ªô A2", icon: "üó£Ô∏è", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=ENGA2']},
        { id: 11, idProducts: 11, title: "To√°n n√¢ng cao 11", price: 85000, description: "Tuy·ªÉn t·∫≠p c√°c b√†i to√°n n√¢ng cao l·ªõp 11", icon: "‚ûï", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=TNC11']},
        { id: 12, idProducts: 12, title: "ƒê·ªãa l√Ω 12", price: 40000, description: "S√°ch gi√°o khoa ƒê·ªãa l√Ω l·ªõp 12", icon: "üåç", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=DLY12']},
        { id: 13, idProducts: 13, title: "Gi√°o d·ª•c c√¥ng d√¢n 12", price: 30000, description: "S√°ch gi√°o khoa GDCD l·ªõp 12", icon: "‚öñÔ∏è", imageLinks: ['https://via.placeholder.com/250x250/F0F0F0?text=GDCD']},
    ];


    // S·∫¢N PH·∫®M N·ªîI B·∫¨T (4 s·∫£n ph·∫©m ƒë·∫ßu)
    const featuredProducts = featuredProductsFromController.length > 0 ? featuredProductsFromController : mockProducts.slice(0, 4);

    // T·∫§T C·∫¢ S·∫¢N PH·∫®M (D√πng cho ph√¢n trang)
    const allProducts = allProductsData.length > 0 ? allProductsData : mockProducts;

    // D√πng danh s√°ch ƒë·∫ßy ƒë·ªß ƒë·ªÉ tra c·ª©u chung (getProductById)
    const products = allProducts;


    // --- 2. LOGIC GI·ªé H√ÄNG (GUEST CART) ---
    let cart = JSON.parse(localStorage.getItem('bookstoreCart') || '[]');

    document.addEventListener('DOMContentLoaded', function() {
        // HI·ªÇN TH·ªä S·∫¢N PH·∫®M N·ªîI B·∫¨T
        if (featuredProducts && featuredProducts.length > 0) {
            displayProducts(featuredProducts, 'productList');
        }

        // THI·∫æT L·∫¨P V√Ä HI·ªÇN TH·ªä TRANG S·∫¢N PH·∫®M ƒê·∫¶U TI√äN
        if (allProducts && allProducts.length > 0) {
            setupPagination();
            renderProductsPage(currentPage);
        }

        updateCartUI(); // G·ªçi ngay khi t·∫£i trang ƒë·ªÉ c·∫≠p nh·∫≠t Badge v√† Modal
    });


    // --- H√ÄM PH√ÇN TRANG (PAGINATION) ---

    function setupPagination() {
        totalPages = Math.ceil(allProducts.length / productsPerPage);
        renderPaginationButtons();
    }

    function renderProductsPage(page) {
        currentPage = page;
        const startIndex = (page - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        const productsToShow = allProducts.slice(startIndex, endIndex);

        displayProducts(productsToShow, 'allProductList');
        renderPaginationButtons();

        // Cu·ªôn l√™n ƒë·∫ßu m·ª•c s·∫£n ph·∫©m khi chuy·ªÉn trang
        document.getElementById('all-products').scrollIntoView({ behavior: 'smooth' });
    }

    function renderPaginationButtons() {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';

        if (totalPages <= 1) return;

        let paginationHTML = '<ul class="pagination">';

        // N√∫t Previous
        paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                              <a class="page-link" href="#" onclick="renderProductsPage(${currentPage - 1}); return false;">&laquo;</a>
                           </li>`;

        // C√°c n√∫t s·ªë trang
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `<li class="page-item ${currentPage === i ? 'active' : ''}">
                                 <a class="page-link" href="#" onclick="renderProductsPage(${i}); return false;">${i}</a>
                              </li>`;
        }

        // N√∫t Next
        paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                              <a class="page-link" href="#" onclick="renderProductsPage(${currentPage + 1}); return false;">&raquo;</a>
                           </li>`;

        paginationHTML += '</ul>';
        paginationContainer.innerHTML = paginationHTML;
    }


    // --- C√ÅC H√ÄM TI·ªÜN √çCH ---

    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(price);
    }

    function getProductById(productId) {
        // T√¨m ki·∫øm s·∫£n ph·∫©m trong danh s√°ch tra c·ª©u chung
        return products.find(p => p.idProducts === productId || p.id === productId);
    }

    // H√ÄM M·ªöI: X·ª≠ l√Ω linh ho·∫°t vi·ªác l·∫•y ƒë∆∞·ªùng d·∫´n ·∫£nh t·ª´ product.imageLinks
    function getFirstImageLink(product) {
        if (!product.imageLinks || product.imageLinks.length === 0) {
            return null;
        }

        let link = product.imageLinks[0];

        // Tr∆∞·ªùng h·ª£p 1 & 2: D·ªØ li·ªáu l√† ƒë·ªëi t∆∞·ª£ng ImageProduct ho·∫∑c DTO
        if (typeof link === 'object' && link !== null) {
            // ∆Øu ti√™n truy c·∫≠p thu·ªôc t√≠nh m√† b·∫°n ƒë√£ khai b√°o trong Entity (image_link)
            if (link.image_link) {
                link = link.image_link;
            } else if (link.imageLink) {
                link = link.imageLink;
            } else {
                return null;
            }
        }

        // Tr∆∞·ªùng h·ª£p 3: Chu·∫©n h√≥a ƒë∆∞·ªùng d·∫´n: LO·∫†I B·ªé PREFIX V·∫¨T L√ù V√Ä FILE
        if (typeof link === 'string') {
            // Lo·∫°i b·ªè 'file:'
            if (link.startsWith('file:')) {
                link = link.substring(link.indexOf('/images/')); // Gi·∫£ ƒë·ªãnh ƒë∆∞·ªùng d·∫´n c√¥ng khai b·∫Øt ƒë·∫ßu t·ª´ /images/
            }
            // Lo·∫°i b·ªè c√°c ƒë∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi kh√¥ng c·∫ßn thi·∫øt
            let staticPath = '/src/main/resources/static';
            if (link.includes(staticPath)) {
                link = link.substring(link.indexOf('/images/'));
            }

            return link;
        }

        return null;
    }


    // --- H√ÄM HI·ªÇN TH·ªä S·∫¢N PH·∫®M TR√äN PAGE ---
    // THAY ƒê·ªîI: Th√™m tham s·ªë containerId ƒë·ªÉ hi·ªÉn th·ªã ·ªü khu v·ª±c mong mu·ªën
    function displayProducts(productsToShow, containerId) {
        const productList = document.getElementById(containerId);
        if (!productList) return; // B·∫£o v·ªá n·∫øu kh√¥ng t√¨m th·∫•y container
        productList.innerHTML = '';

        const defaultIcon = '<i class="fas fa-book fa-5x"></i>';

        productsToShow.forEach(product => {
            const productId = product.idProducts || product.id;
            const detailUrl = `/products/${productId}`;

            // X·ª≠ l√Ω m√¥ t·∫£ ng·∫Øn
            const shortDescription = product.description
                ? (product.description.length > 50 ? product.description.substring(0, 50) + '...' : product.description)
                : 'Ch∆∞a c√≥ m√¥ t·∫£.';

            // L·∫•y ƒë∆∞·ªùng d·∫´n ·∫£nh cho th·∫ª (s·ª≠ d·ª•ng h√†m m·ªõi)
            const imageLink = getFirstImageLink(product);
            // D√πng placeholder nh·ªè cho th·∫ª s·∫£n ph·∫©m n·∫øu kh√¥ng c√≥ link h·ª£p l·ªá
            const imageContent = imageLink
                ? `<img src="${imageLink}" alt="${product.title || product.name}">`
                : (product.icon || defaultIcon);

            // L·∫•y gi√° hi·ªÉn th·ªã
            const displayPrice = product.price || 0;

            const productCard = `
                    <div class="col-lg-3 col-md-6">
                        <div class="product-card">
                            <div class="product-image">
                                ${imageContent}
                            </div>
                            <div class="product-info">
                                <h5 class="product-title" onclick="showProductDetail(${productId})">${product.title || product.name}</h5>
                                <p class="text-muted">${shortDescription}</p>
                                <div class="product-price">${formatPrice(displayPrice)}</div>
                                <div class="d-flex">
                                    <button class="btn btn-add-cart" onclick="addToCart(${productId})">
                                        <i class="fas fa-cart-plus"></i> Th√™m v√†o gi·ªè
                                    </button>
                                    <button class="btn btn-order" onclick="orderNow(${productId})">
                                        <i class="fas fa-shopping-bag"></i> ƒê·∫∑t h√†ng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            productList.innerHTML += productCard;
        });
    }

    // --- C√ÅC H√ÄM X·ª¨ L√ù KH√ÅC (GI·ªÆ NGUY√äN) ---

    function addToCart(productId) {
        const product = getProductById(productId);
        const existingItem = cart.find(item => item.idProducts === productId);

        if (!product) return;

        if (existingItem) {
            existingItem.quantity += 1;
        } else {
            // L∆ØU ƒê∆Ø·ªúNG D·∫™N ·∫¢NH ƒê√É ƒê∆Ø·ª¢C X·ª¨ L√ù V√ÄO LOCALSTORAGE
            const imageLink = getFirstImageLink(product);

            cart.push({
                idProducts: productId,
                title: product.title || product.name,
                price: product.price,
                quantity: 1,
                imageLink: imageLink
            });
        }

        localStorage.setItem('bookstoreCart', JSON.stringify(cart));
        updateCartUI();
        showNotification(`ƒê√£ th√™m ${product.title || product.name} v√†o gi·ªè h√†ng!`, 'success');
    }

    function orderNow(productId) {
        addToCart(productId);
        const cartModal = new bootstrap.Modal(document.getElementById('cartModal'));
        cartModal.show();
    }

    function updateCartUI() {
        const cartCount = document.getElementById('cartCount');
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        cartCount.textContent = totalItems;
        updateCartModal();
    }

    /**
     * Modal Gi·ªè h√†ng hi·ªÉn th·ªã chi ti·∫øt s·∫£n ph·∫©m (·∫£nh, t√™n, gi√°, s·ªë l∆∞·ª£ng).
     */
    function updateCartModal() {
        const cartItems = document.getElementById('cartItems');
        const totalPrice = document.getElementById('totalPrice');
        const checkoutBtn = document.getElementById('checkoutBtn');

        let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
        let totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);


        if (cart.length === 0) {
            cartItems.innerHTML = '<p class="text-center text-muted p-4">Gi·ªè h√†ng t·∫°m th·ªùi ƒëang tr·ªëng.</p>';
            totalPrice.textContent = '0ƒë';
            checkoutBtn.classList.add('disabled');
            return;
        }

        let cartHTML = '';

        cart.forEach(item => {
            const itemId = item.idProducts;
            const imgSource = item.imageLink || 'https://via.placeholder.com/60x60/DEDEDE?text=Book';

            cartHTML += `
                <div class="cart-item-detail">
                    <div class="d-flex align-items-center">
                        <img src="${imgSource}" alt="${item.title}" loading="lazy">
                        <div>
                            <a href="#" class="item-title-link" onclick="showProductDetail(${itemId}); return false;">
                                <h6 class="mb-0">${item.title}</h6>
                            </a>
                            <small class="text-muted">${formatPrice(item.price)}</small>
                        </div>
                    </div>

                    <div class="d-flex align-items-center">
                        <button class="btn btn-sm btn-outline-secondary me-1" onclick="updateQuantityModal(${itemId}, -1)">-</button>
                        <span class="mx-2 fw-bold">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-secondary me-3" onclick="updateQuantityModal(${itemId}, 1)">+</button>

                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromCart(${itemId})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });

        cartItems.innerHTML = cartHTML;
        totalPrice.textContent = formatPrice(total);
        checkoutBtn.classList.remove('disabled');
    }

    function updateQuantityModal(productId, change) {
        const item = cart.find(item => item.idProducts === productId || item.id === productId);
        if (item) {
            let newQuantity = item.quantity + change;

            if (newQuantity < 1) {
                showNotification('S·ª≠ d·ª•ng n√∫t x√≥a ƒë·ªÉ lo·∫°i b·ªè ho√†n to√†n s·∫£n ph·∫©m.', 'warning');
                return;
            }

            item.quantity = newQuantity;
            localStorage.setItem('bookstoreCart', JSON.stringify(cart));
            updateCartUI();
        }
    }


    function updateQuantity(productId, change) {
        const item = cart.find(item => item.idProducts === productId || item.id === productId);
        if (item) {
            let newQuantity = item.quantity + change;

            if (newQuantity < 1) {
                showNotification('S·ª≠ d·ª•ng n√∫t x√≥a ƒë·ªÉ lo·∫°i b·ªè ho√†n to√†n s·∫£n ph·∫©m.', 'warning');
                return;
            }

            item.quantity = newQuantity;

            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                localStorage.setItem('bookstoreCart', JSON.stringify(cart));
                updateCartUI();
            }
        }
    }

    function removeFromCart(productId) {
        cart = cart.filter(item => item.idProducts !== productId && item.id !== productId);
        localStorage.setItem('bookstoreCart', JSON.stringify(cart));
        updateCartUI();
        showNotification('ƒê√£ x√≥a kh·ªèi gi·ªè h√†ng!', 'info');
    }

    function searchBooks() {
        const searchTerm = document.getElementById('searchInput').value.trim();
        if (searchTerm) {
            window.location.href = `/products?keyword=${searchTerm}`;
        }
    }

    function filterByCategory(categoryId) {
        window.location.href = `/products?categoryId=${categoryId}`;
    }

    function showProductDetail(productId) {
        window.location.href = `/products/${productId}`;
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        const alertClass = type === 'success' ? 'alert-success' :
            type === 'warning' ? 'alert-warning' :
                type === 'error' ? 'alert-danger' : 'alert-info';

        notification.className = `alert ${alertClass} position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
            `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 3000);
    }
</script>
</body>
</html>